# Stock Scanner API Documentation

## Overview

The Stock Scanner API provides AI-powered stock analysis, sentiment tracking, and automated alerting capabilities. It combines multiple data sources to generate high-confidence stock picks based on market sentiment, premarket activity, and technical signals.

## Base URL

```
https://your-worker-name.workers.dev
```

## Authentication

Currently, the API is open. For production use, consider adding authentication via Cloudflare Access or custom middleware.

## Endpoints

### Market Data

#### Get Premarket Data

Retrieves top gainers, losers, and volume spikes in premarket trading.

**Endpoint:** `GET /stocks/premarket`

**Response:**
```json
{
  "success": true,
  "result": {
    "topGainers": [
      {
        "symbol": "NVDA",
        "price": 485.20,
        "change": 25.30,
        "changePercent": 5.5,
        "volume": 8500000,
        "companyName": "NVIDIA Corporation"
      }
    ],
    "topLosers": [
      {
        "symbol": "F",
        "price": 12.50,
        "change": -0.85,
        "changePercent": -6.4,
        "volume": 12000000,
        "companyName": "Ford Motor Company"
      }
    ],
    "volumeSpikes": [
      {
        "symbol": "TSLA",
        "price": 245.00,
        "change": 8.50,
        "changePercent": 3.6,
        "volume": 95000000,
        "companyName": "Tesla Inc."
      }
    ],
    "timestamp": "2025-10-26T07:00:00.000Z"
  }
}
```

### Stock Picks

#### Get AI Stock Picks

Returns stock picks generated by the AI scanner with confidence scores and reasoning.

**Endpoint:** `GET /stocks/picks`

**Query Parameters:**
- `min_confidence` (optional, number): Minimum confidence score filter (0.0 - 1.0). Default: 0.6
- `limit` (optional, number): Maximum number of picks to return (1-100). Default: 10

**Example Request:**
```bash
curl https://your-worker.workers.dev/stocks/picks?min_confidence=0.75&limit=5
```

**Response:**
```json
{
  "success": true,
  "result": {
    "picks": [
      {
        "symbol": "AAPL",
        "companyName": "Apple Inc.",
        "confidenceScore": 0.85,
        "sentimentScore": 0.72,
        "price": 185.50,
        "volume": 45000000,
        "priceChangePercent": 2.5,
        "reasoning": [
          "Strong price movement: +2.5%",
          "High volume: 45.0M shares",
          "Very positive sentiment (72%)",
          "Trending on social media",
          "Key topics: earnings, bullish, breakout"
        ],
        "dataSources": ["twitter", "reddit", "news", "market_data"],
        "isPremarket": true,
        "pickDate": "2025-10-26T07:00:00.000Z"
      }
    ],
    "count": 1,
    "timestamp": "2025-10-26T07:15:00.000Z"
  }
}
```

**Field Descriptions:**
- `confidenceScore`: Algorithm's confidence in the pick (0.0 - 1.0)
- `sentimentScore`: Overall sentiment from social media and news (-1.0 to 1.0)
- `reasoning`: Array of human-readable reasons for the pick
- `dataSources`: Sources used to generate the pick
- `isPremarket`: Whether this is a premarket pick

### Sentiment Analysis

#### Get Stock Sentiment

Retrieves aggregated sentiment analysis for a specific stock from multiple sources.

**Endpoint:** `GET /stocks/sentiment/:symbol`

**Parameters:**
- `symbol` (path, string): Stock ticker symbol (e.g., AAPL, TSLA, MSFT)

**Example Request:**
```bash
curl https://your-worker.workers.dev/stocks/sentiment/AAPL
```

**Response:**
```json
{
  "success": true,
  "result": {
    "symbol": "AAPL",
    "overallScore": 0.65,
    "sources": [
      {
        "name": "twitter",
        "score": 0.70,
        "mentions": 850,
        "keywords": ["bullish", "earnings", "breakout", "moon", "buy"]
      },
      {
        "name": "reddit",
        "score": 0.58,
        "mentions": 245,
        "keywords": ["hold", "earnings", "resistance"]
      },
      {
        "name": "news",
        "score": 0.68,
        "mentions": 42,
        "keywords": ["revenue beat", "guidance", "bullish"]
      }
    ],
    "trending": true,
    "timestamp": "2025-10-26T07:20:00.000Z"
  }
}
```

**Field Descriptions:**
- `overallScore`: Weighted average sentiment across all sources (-1.0 to 1.0)
  - > 0.5: Very bullish
  - 0.2 to 0.5: Bullish
  - -0.2 to 0.2: Neutral
  - -0.5 to -0.2: Bearish
  - < -0.5: Very bearish
- `trending`: Whether the stock has high mention volume
- `keywords`: Top trending keywords related to the stock

### Scanner Control

#### Trigger Stock Scan

Manually triggers the stock scanning algorithm and optionally posts results to Twitter/X.

**Endpoint:** `POST /stocks/scan`

**Request Body:**
```json
{
  "min_confidence": 0.6,
  "tweet_results": false,
  "limit": 10
}
```

**Parameters:**
- `min_confidence` (optional, number): Minimum confidence threshold. Default: 0.6
- `tweet_results` (optional, boolean): Whether to post results to Twitter. Default: false
- `limit` (optional, number): Maximum number of picks to generate. Default: 10

**Example Request:**
```bash
curl -X POST https://your-worker.workers.dev/stocks/scan \
  -H "Content-Type: application/json" \
  -d '{
    "min_confidence": 0.7,
    "tweet_results": false,
    "limit": 5
  }'
```

**Response:**
```json
{
  "success": true,
  "result": {
    "picks": [...],
    "count": 5,
    "tweeted": false,
    "timestamp": "2025-10-26T07:25:00.000Z"
  }
}
```

If `tweet_results` is true and Twitter is configured:
```json
{
  "success": true,
  "result": {
    "picks": [...],
    "count": 5,
    "tweeted": true,
    "tweetResults": [
      {
        "success": true,
        "tweetId": "1234567890",
        "message": "Tweet sent successfully"
      }
    ],
    "timestamp": "2025-10-26T07:25:00.000Z"
  }
}
```

### Earnings Calendar

#### Get Earnings Calendar

Retrieves upcoming and past earnings events with estimates and actuals.

**Endpoint:** `GET /stocks/earnings`

**Query Parameters (D1 List Endpoint):**
- `search` (optional, string): Search term for symbol or company name
- `orderBy` (optional, string): Sort field. Default: "earnings_date DESC"
- `page` (optional, number): Page number for pagination. Default: 1
- `perPage` (optional, number): Results per page. Default: 20

**Example Request:**
```bash
curl https://your-worker.workers.dev/stocks/earnings?search=AAPL&perPage=10
```

**Response:**
```json
{
  "success": true,
  "result": [
    {
      "id": 1,
      "symbol": "AAPL",
      "company_name": "Apple Inc.",
      "earnings_date": "2025-10-28T20:00:00.000Z",
      "estimate_eps": 1.55,
      "actual_eps": null,
      "surprise_percent": null,
      "time_of_day": "AMC",
      "is_confirmed": 1,
      "alert_sent": 0,
      "created_at": "2025-10-20T10:00:00.000Z",
      "updated_at": "2025-10-26T07:00:00.000Z"
    }
  ]
}
```

**Field Descriptions:**
- `time_of_day`: "BMO" (Before Market Open) or "AMC" (After Market Close)
- `estimate_eps`: Analyst consensus EPS estimate
- `actual_eps`: Reported EPS (null if not yet announced)
- `surprise_percent`: (Actual - Estimate) / Estimate * 100

### Configuration

#### Get Scanner Configuration

Retrieves the current scanner configuration including filters and preferences.

**Endpoint:** `GET /stocks/config`

**Response:**
```json
{
  "success": true,
  "result": {
    "sentiment_sources": ["twitter", "reddit", "news"],
    "sectors_filter": ["Technology", "Healthcare", "Finance", "Energy", "Consumer"],
    "min_confidence_score": 0.6,
    "min_volume_threshold": 1000000,
    "keywords": ["earnings", "merger", "FDA approval", "buyout", "breakthrough"],
    "tweet_enabled": true,
    "premarket_scan_time": "07:00"
  }
}
```

#### Update Scanner Configuration

Updates scanner filters and preferences.

**Endpoint:** `PUT /stocks/config`

**Request Body:**
```json
{
  "min_confidence_score": 0.7,
  "min_volume_threshold": 2000000,
  "tweet_enabled": false,
  "keywords": ["earnings", "buyout", "FDA approval", "revenue beat"]
}
```

**Note:** Only include fields you want to update. Omitted fields will remain unchanged.

**Response:**
```json
{
  "success": true,
  "result": {
    "updated": ["min_confidence_score", "min_volume_threshold", "tweet_enabled", "keywords"],
    "message": "Updated 4 configuration setting(s)"
  }
}
```

## Error Handling

All endpoints follow a consistent error response format:

**Success Response:**
```json
{
  "success": true,
  "result": { ... }
}
```

**Error Response:**
```json
{
  "success": false,
  "errors": [
    {
      "code": 7000,
      "message": "Error description"
    }
  ]
}
```

**Common HTTP Status Codes:**
- `200 OK`: Request successful
- `400 Bad Request`: Invalid request parameters
- `404 Not Found`: Resource not found
- `500 Internal Server Error`: Server error

## Rate Limiting

Currently, no rate limiting is enforced. For production use, consider implementing rate limiting via Cloudflare Rate Limiting or custom middleware.

## Data Sources and Mock Data

**Current Implementation:**
The current implementation uses mock data for demonstration purposes. The following services need to be connected to real APIs in production:

1. **Market Data**: Update `src/services/marketData.ts` to integrate with providers like:
   - Alpha Vantage
   - Polygon.io
   - IEX Cloud
   - Yahoo Finance API

2. **Sentiment Analysis**: Update `src/services/sentimentAnalysis.ts` to integrate with:
   - Twitter/X API v2
   - Reddit API
   - News APIs (NewsAPI, Benzinga, etc.)

3. **Social Posting**: Configure Twitter API credentials in environment variables:
   - `TWITTER_API_KEY`
   - `TWITTER_API_SECRET`
   - `TWITTER_ACCESS_TOKEN`
   - `TWITTER_ACCESS_TOKEN_SECRET`

## Automated Scanning

To set up automated premarket scans, use Cloudflare Cron Triggers:

1. Add to `wrangler.jsonc`:
```json
{
  "triggers": {
    "crons": ["0 7 * * 1-5"]  // 7 AM UTC, weekdays only
  }
}
```

2. Add scheduled handler in `src/index.ts`:
```typescript
export default {
  async scheduled(event, env, ctx) {
    // Trigger stock scan
    const scanner = new StockScannerService();
    const config = await getConfigFromDB(env.DB);
    const picks = await scanner.scanStocks(config);
    
    // Post to Twitter if enabled
    if (config.tweet_enabled) {
      const twitter = new TwitterService();
      await twitter.tweetPicksThread(picks.slice(0, 5));
    }
  }
};
```

## Examples

### Example 1: Get Top Premarket Movers
```bash
curl https://your-worker.workers.dev/stocks/premarket
```

### Example 2: Get High-Confidence Stock Picks
```bash
curl "https://your-worker.workers.dev/stocks/picks?min_confidence=0.8&limit=5"
```

### Example 3: Analyze Sentiment for TSLA
```bash
curl https://your-worker.workers.dev/stocks/sentiment/TSLA
```

### Example 4: Trigger Scan and Tweet Results
```bash
curl -X POST https://your-worker.workers.dev/stocks/scan \
  -H "Content-Type: application/json" \
  -d '{"min_confidence": 0.7, "tweet_results": true, "limit": 3}'
```

### Example 5: Update Configuration
```bash
curl -X PUT https://your-worker.workers.dev/stocks/config \
  -H "Content-Type: application/json" \
  -d '{"min_confidence_score": 0.75, "tweet_enabled": true}'
```

## OpenAPI Schema

The full OpenAPI 3.1 schema is available at:
```
https://your-worker.workers.dev/
```

You can also extract it locally:
```bash
npm run schema
```

## Support

For issues or questions, please open an issue on the GitHub repository.
